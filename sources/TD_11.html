<html>
<head>
    <title>WebGL</title>
    <meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">

    <style type="text/css">
        body {
            overflow: hidden;
        }

        canvas {
            position: fixed;
            display: block;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
        }
    </style>

    <!-- External libs -->
    <!-- http://glmatrix.net/docs/2.1.0/ -->
    <script type="text/javascript" src="lib/gl-matrix-min.js"></script>
    <!-- http://underscorejs.org/ -->
    <script type="text/javascript" src="lib/underscore-min.js"></script>
    <!-- http://api.jquery.com/ -->
    <script type="text/javascript" src="lib/jquery-2.0.3.min.js"></script>

    <!-- source code -->
    <script type="text/javascript" src="lib/GL.js"></script>
    <script type="text/javascript" src="lib/FileLoader.js"></script>
    <script type="text/javascript" src="lib/Events.js"></script>
    <script type="text/javascript" src="lib/KeyMapping.js"></script>
    <script type="text/javascript" src="lib/KeyboardManager.js"></script>
    <script type="text/javascript" src="lib/MouseManager.js"></script>

    <script type="text/javascript" src="lib/Texture.js"></script>
    <script type="text/javascript" src="lib/RenderTarget.js"></script>
    <script type="text/javascript" src="lib/Material.js"></script>
    <script type="text/javascript" src="lib/Object3D.js"></script>
    <script type="text/javascript" src="lib/Mesh.js"></script>

    <script type="text/javascript" src="lib/Renderer.js"></script>
    <script type="text/javascript" src="lib/Camera.js"></script>

    <script type="text/javascript">
        function start() {
            Events.InitializeEvents();
            var canvas = document.getElementById("renderingCanvas");

            var camera = new Camera({
                pos: {x: -2500, y: 3000, z: 2500},
                target: {x: 0, y: 2000, z: 0},
                fov: Math.PI / 3,
                aspectRatio: canvas.width / canvas.height,
                near: 1.0,
                far: 100000.0
            });

            var glParams = {
                alpha: false,
                depth: true,
                stencil: false,
                antialias: true,
                premultipliedAlpha: false,
                preserveDrawingBuffer: false,
                preferLowPowerToHighPerformance: false,
                failIfMajorPerformanceCaveat: false
            };
            var renderer = new Renderer(canvas, glParams);
            camera.bindCommands(renderer.keyboardManager);

            var lightDirection = vec3.fromValues(0.3,0.2,0.4);
            var lightColor = vec3.fromValues(0.85,0.8,0.6);
            var ambientColor = vec3.fromValues(0.1,0.1,0.1);
//            var lightPosition = vec2.fromvalues();

            var houseMesh = new Mesh("house");
            houseMesh.loadFromObjFile("data/house.obj");
            var houseMat = new Material("house", "data/shader/dirLight.vShader", "data/shader/default.fShader",
                    function (mat) {
                        mat.uniforms["texture0"].texture = new Texture("data/house_diffuse.png");
                        mat.uniforms["lightDir"].value = lightDirection;
                        mat.uniforms["lightColor"].value = lightColor;
                        mat.uniforms["ambientColor"].value = ambientColor;
                    });
//            houseMat.blendEquation = GL.FUNC_ADD;
//            houseMat.dstBlend = GL.ONE;
//            houseMat.srcBlend = GL.ONE;

            var houseObject = [];

            for(var i= 0;i<20;i++){

//                var houseObject = new Object3D(houseMesh, houseMat);
                houseObject[i] = new Object3D(houseMesh, houseMat);
                houseObject[i].setPosition(Math.cos(i)*3000,0,Math.sin(i)*3000);

                houseObject[i].setRotation(0,Math.sin(i)*90,0);
            }




            var groundMesh = new Mesh("ground");
            groundMesh.loadFromObjFile("data/Landscape.obj");
            var groundMat = new Material("ground", "data/shader/groundShader.vShader", "data/shader/groundShader.fShader",
                    function (mat) {
                        var grassTex = new Texture("data/grass_diffuse.png");
                        grassTex.wrapping = GL.REPEAT;
                        grassTex.minFilter = GL.LINEAR_MIPMAP_LINEAR;
                        grassTex.magFilter = GL.LINEAR;
                        mat.uniforms["texture0"].texture = grassTex;

                        var sandTex = new Texture("data/Sand.jpg");
                        sandTex.wrapping = GL.REPEAT;
                        sandTex.minFilter = GL.LINEAR_MIPMAP_LINEAR;
                        sandTex.magFilter = GL.LINEAR;
                        mat.uniforms["texture1"].texture = sandTex;

                        mat.uniforms["waterHeight"].value = 800;
                        mat.uniforms["lightDir"].value = lightDirection;
                        mat.uniforms["lightColor"].value = lightColor;
                        mat.uniforms["ambientColor"].value = ambientColor;
                    });
            var groundObject = new Object3D(groundMesh, groundMat);


            var sphereMesh = new Mesh("sphere");
            sphereMesh.loadFromObjFile("data/Sphere.obj");
            var sphereMat = new Material("shpere", "data/shader/sky.vShader", "data/shader/sky.fShader",
                    function (mat) {
                        var grassTex = new Texture("data/GradientSky.png");

                        mat.uniforms["texture0"].texture = grassTex;

//                        var sandTex = new Texture("data/EnvMap.jpg");
//                        mat.uniforms["texture1"].texture = sandTex;

                        mat.uniforms["lightDir"].value = lightDirection;
//                        mat.uniforms["cloudDensity"].value = lightDirection;
//                        mat.uniforms["windSpeed"].value = lightDirection;
                    });
            sphereMat.doubleSided = true;
            var sphereObject = new Object3D(sphereMesh, sphereMat);
            sphereObject.setScale(camera.far*0.7,camera.far*0.7,camera.far*0.7);
            sphereObject.setPosition(0,-5000,0);


            function render(deltaTime) {
                renderer.setCamera(camera);
                renderer.setRenderTarget(null);
                renderer.clear({r: 0.31, g: 0.59, b: 0.78, a: 1.0});
                renderer.renderObject(groundObject);
                renderer.renderObject(sphereObject);
//                renderer.renderObject(houseObject2);
                for(var i in houseObject) {
                    renderer.renderObject(houseObject[i]);
                }
            }

            Events.AddEventListener(Events.onRender, render);
        }
    </script>
</head>
<body onload="start();" oncontextmenu="return false;">
<div>
    <canvas id="renderingCanvas"></canvas>
</div>
</body>
</html>
